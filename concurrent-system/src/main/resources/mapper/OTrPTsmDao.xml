<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org/DTD Mapper 3.0" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.beanpodtech.pkms.dbadapter.dao.IOTrPTsmDao">


    <!-- TRANSACTION_TASK_INFO -->
    <sql id="tTaskInfoCol">
        ID AS 'id',
        TASK_ID AS 'taskId',
        TASK_STATE AS 'taskState',
        IPADDRESS AS 'ipAddress',
        TEE_NAME AS 'teeName',
        TEE_CERT AS 'teeCert',
        SHA_TA_ID AS 'shaTAId',
        UPDATE_TIME AS 'updateTime',
        DELETE_FLAG AS 'deleteFlag',
        CREATE_TIME AS 'createTime'
    </sql>

    <insert id="insertTransactionTaskInfo" parameterType="TransactionTaskInfo">
        INSERT INTO transaction_task_info(TASK_ID, IPADDRESS, TEE_NAME, TEE_CERT, SHA_TA_ID, UPDATE_TIME, CREATE_TIME)
        VALUES (#{taskId}, #{ipAddress}, #{teeName}, #{teeCert}, #{shaTAId}, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP )
    </insert>

    <select id="selectTransactionTaskInfoByTid" parameterType="string" resultType="TransactionTaskInfo">
        SELECT
        <include refid="tTaskInfoCol" />
        FROM transaction_task_info
        WHERE TASK_ID = #{taskId} AND DELETE_FLAG = 1
    </select>

    <update id="updateTransactionTaskInfoById" parameterType="TransactionTaskInfo">
        UPDATE transaction_task_info
        SET TEE_CERT = #{teeCert},
            TASK_STATE = #{taskState},
            UPDATE_TIME = CURRENT_TIMESTAMP
        WHERE ID = #{id}
    </update>

    <!-- REQUEST_TASK_INFO -->
    <sql id="rTaskInfoCol">
        ID AS 'id',
        RID AS 'rid',
        TID AS 'tid',
        R_STATE AS 'rState',
        OPT_FLAG AS 'optFlag',
        RSP_DSI_HASH AS 'rspDSIHash',
        RSP_DSI_DAT AS 'rspDSIDat',
        UPDATE_TIME AS 'updateTime',
        DELETE_FLAG AS 'deleteFlag',
        CREATE_TIME AS 'createTime'
    </sql>

    <insert id="insertRequestTaskInfo" parameterType="RequestTaskInfo">
        INSERT INTO request_task_info(RID, TID, OPT_FLAG, RSP_DSI_HASH, RSP_DSI_DAT, UPDATE_TIME, CREATE_TIME)
        VALUES (#{rid}, #{tid}, #{optFlag}, #{rspDSIHash}, #{rspDSIDat}, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP )
    </insert>

    <resultMap id="ResultMap_RequestTaskInfo" type="com.beanpodtech.pkms.common.model.RequestTaskInfo" >
        <id column="id" property="id" jdbcType="BIGINT" />
        <result column="rid" property="rid" jdbcType="VARCHAR" />
        <result column="tid" property="tid" jdbcType="BIGINT" />
        <result column="rState" property="rState" jdbcType="BIT" />
        <result column="optFlag" property="optFlag" jdbcType="VARCHAR" />
        <result column="rspDSIHash" property="rspDSIHash" jdbcType="VARCHAR" />
        <result column="rspDSIDat" property="rspDSIDat" jdbcType="VARCHAR" />
        <result column="updateTime" property="updateTime" jdbcType="TIMESTAMP" />
        <result column="deleteFlag" property="deleteFlag" jdbcType="BIT" />
        <result column="createTime" property="createTime" jdbcType="TIMESTAMP" />
    </resultMap>

    <select id="selectRequestTaskInfoByTid" parameterType="int" resultMap="ResultMap_RequestTaskInfo">
        SELECT
        <include refid="rTaskInfoCol" />
        FROM request_task_info
        WHERE TID = #{tid} AND DELETE_FLAG = 1
    </select>

    <update id="updateRequestTaskInfoById" parameterType="RequestTaskInfo">
        UPDATE request_task_info
        SET RSP_DSI_HASH = #{rspDSIHash},
        RSP_DSI_DAT = #{rspDSIDat},
        R_STATE = #{rState},
        UPDATE_TIME = CURRENT_TIMESTAMP
        WHERE ID = #{id}
    </update>

</mapper>