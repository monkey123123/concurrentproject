<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org/DTD Mapper 3.0" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.beanpodtech.pkms.dbadapter.dao.ITaInfoDao">

    <!--add by Allen -->
    <resultMap id="ResultMap_TaInfo" type="com.beanpodtech.pkms.common.model.tam.TaInfo" >
        <id column="TA_ID" property="taId" jdbcType="INTEGER" />
        <result column="SHA_TA_ID" property="shaTaId" jdbcType="VARCHAR" />
        <result column="SALT" property="salt" jdbcType="VARCHAR" />
        <result column="APP_LICENSE" property="appLicense" jdbcType="VARCHAR" />
        <result column="TA_NAME" property="taName" jdbcType="VARCHAR" />
        <result column="SP_ID" property="spId" jdbcType="INTEGER" />
        <result column="SIGN_REQ_ID" property="signReqId" jdbcType="INTEGER" />
        <result column="SD_ID" property="sdId" jdbcType="INTEGER" />
        <result column="TEE_ID" property="teeId" jdbcType="INTEGER" />
        <result column="VERSION" property="version" jdbcType="INTEGER" />
        <result column="SUBMITTER" property="submitter" jdbcType="VARCHAR" />
        <result column="DESCRIPTION" property="description" jdbcType="VARCHAR" />
        <result column="DELETE_FLAG" property="deleteFlag" jdbcType="INTEGER" />
        <result column="CREATE_TIME" property="createTime" jdbcType="TIMESTAMP" />
        <result column="OPER_ID" property="operId" jdbcType="VARCHAR" />
        <result column="OPER_TIME" property="operTime" jdbcType="TIMESTAMP" />
    </resultMap>
    <resultMap id="ResultMap_TaInfoVO" type="com.beanpodtech.pkms.common.model.tam.TaInfoVO" >
        <id column="TA_ID" property="taId" jdbcType="INTEGER" />
        <result column="SHA_TA_ID" property="shaTaId" jdbcType="VARCHAR" />
        <result column="SALT" property="salt" jdbcType="VARCHAR" />
        <result column="APP_LICENSE" property="appLicense" jdbcType="VARCHAR" />
        <result column="TA_NAME" property="taName" jdbcType="VARCHAR" />
        <result column="SP_ID" property="spId" jdbcType="INTEGER" />
        <result column="SIGN_REQ_ID" property="signReqId" jdbcType="INTEGER" />
        <result column="SD_ID" property="sdId" jdbcType="INTEGER" />
        <result column="TEE_ID" property="teeId" jdbcType="INTEGER" />
        <result column="VERSION" property="version" jdbcType="INTEGER" />
        <result column="SUBMITTER" property="submitter" jdbcType="VARCHAR" />
        <result column="DESCRIPTION" property="description" jdbcType="VARCHAR" />
        <result column="DELETE_FLAG" property="deleteFlag" jdbcType="INTEGER" />
        <result column="CREATE_TIME" property="createTime" jdbcType="TIMESTAMP" />
        <result column="OPER_ID" property="operId" jdbcType="VARCHAR" />
        <result column="OPER_TIME" property="operTime" jdbcType="TIMESTAMP" />
        <result column="spName" property="spName" jdbcType="VARCHAR" />
        <result column="sdName" property="sdName" jdbcType="VARCHAR" />
        <result column="teeName" property="teeName" jdbcType="VARCHAR" />
        <result column="teeVersion" property="teeVersion" jdbcType="INTEGER" />
        <result column="projectId" property="projectId" jdbcType="INTEGER" />
        <result column="imageTypeId" property="imageTypeId" jdbcType="INTEGER" />
        <result column="fileId" property="fileId" jdbcType="INTEGER" />
        <result column="fileName" property="fileName" jdbcType="VARCHAR" />
        <result column="counter" property="counter" jdbcType="INTEGER" />
        <result column="signHash" property="signHash" jdbcType="VARCHAR" />
        <result column="handleStatus" property="handleStatus" jdbcType="INTEGER" />
        <result column="sdkVersion" property="sdkVersion" jdbcType="VARCHAR" />
        <result column="dlCount" property="dlCount" jdbcType="INTEGER" />
        <result column="signature" property="signature" jdbcType="VARCHAR" />
        <result column="imageTypeName" property="imageTypeName" jdbcType="VARCHAR" />
        <result column="fileHash" property="fileHash" jdbcType="VARCHAR" />
        <collection  property="capabilityList"  ofType="com.beanpodtech.pkms.common.model.tam.TeeCapabilityInfo">
            <id column="CAPABILITY_ID" property="capabilityId" jdbcType="INTEGER" />
            <result column="CAPABILITY_VALUE" property="capabilityValue" jdbcType="INTEGER" />
            <result column="DESCRIPTION_tci" property="description" jdbcType="VARCHAR" />
            <result column="DELETE_FLAG_tci" property="deleteFlag" jdbcType="INTEGER" />
            <result column="CREATE_TIME_tci" property="createTime" jdbcType="TIMESTAMP" />
            <result column="OPER_ID_tci" property="operId" jdbcType="VARCHAR" />
            <result column="OPER_TIME_tci" property="operTime" jdbcType="TIMESTAMP" />
        </collection>
    </resultMap>

    <sql id="sql_select">
      TA_ID,
      SHA_TA_ID ,
      SALT,
      APP_LICENSE ,
      TA_NAME ,
      SP_ID ,
      SIGN_REQ_ID ,
      SD_ID ,
      TEE_ID ,
      VERSION ,
      SUBMITTER ,
      DESCRIPTION ,
      DELETE_FLAG ,
      CREATE_TIME ,
      OPER_ID ,
      OPER_TIME
    </sql>
    <sql id="sql_select_TaInfoVO">
      ta.TA_ID,
      ta.SHA_TA_ID ,
      ta.SALT,
      ta.APP_LICENSE ,
      ta.TA_NAME ,
      ta.SP_ID ,
      ta.SIGN_REQ_ID ,
      ta.SD_ID ,
      ta.TEE_ID ,
      ta.VERSION ,
      ta.SUBMITTER ,
      ta.DESCRIPTION ,
      ta.DELETE_FLAG ,
      ta.CREATE_TIME ,
      ta.OPER_ID ,
      ta.OPER_TIME
      ,sp.SP_NAME spName,
      sd.SD_NAME sdName,
      tee.TEE_NAME teeName,
      tee.VERSION teeVersion
      ,
        sr.PROJECT_ID AS 'projectId',
        sr.IMAGE_TYPE_ID AS 'imageTypeId',
        sr.FILE_ID AS 'fileId',
        sr.FILE_NAME AS 'fileName',
        sr.COUNTER AS 'counter',
        sr.SIGNATURE_HASH AS 'signHash',
        sr.HANDLE_STATUS AS 'handleStatus',
        sr.SDK_VERSION AS 'sdkVersion',
        sr.DL_COUNT AS 'dlCount',
        sr.SIGNATURE AS 'signature',
        it.IMAGE_TYPE_NAME AS 'imageTypeName',
        fi.FILE_HASH AS 'fileHash'
    </sql>

    <sql id="sql_insert">
      SHA_TA_ID ,
      SALT,
      APP_LICENSE ,
      TA_NAME ,
      SP_ID ,
      SIGN_REQ_ID ,
      SD_ID ,
      TEE_ID ,
      VERSION ,
      SUBMITTER ,
      DESCRIPTION ,
      DELETE_FLAG ,
      CREATE_TIME ,
      OPER_ID ,
      OPER_TIME
    </sql>

    <!-- 单表 操作 useGeneratedKeys="true"会将自动生成的主键赋值给parameterType="TaInfo"的实体对象 -->
    <insert id="insertTaInfo" parameterType="TaInfo" useGeneratedKeys="true" keyProperty="taId">
        INSERT INTO ta_info(<include refid="sql_insert"/> )
        VALUES (#{shaTaId},#{salt},#{appLicense},
            #{taName},#{spId},#{signReqId},#{sdId},#{teeId},
            #{version},#{submitter},#{description},
            #{deleteFlag},CURRENT_TIMESTAMP,#{operId},CURRENT_TIMESTAMP
        )
    </insert>

    <update id="updateTaInfo" parameterType="TaInfo">
        UPDATE ta_info
        SET
        <if test="shaTaId != null">SHA_TA_ID = #{shaTaId},</if>
        <if test="salt != null">SALT = #{salt},</if>
        <if test="appLicense != null">APP_LICENSE = #{appLicense},</if>
        <if test="taName != null">TA_NAME = #{taName},</if>
        <if test="spId != null">SP_ID = #{spId},</if>
        <if test="signReqId != null">SIGN_REQ_ID = #{signReqId},</if>
        <if test="sdId != null">SD_ID = #{sdId},</if>
        <if test="teeId != null">TEE_ID = #{teeId},</if>
        <if test="version != null">VERSION = #{version},</if>
        <if test="submitter != null">SUBMITTER = #{submitter},</if>
        <if test="description != null">DESCRIPTION = #{description},</if>
        <if test="deleteFlag != null">DELETE_FLAG = #{deleteFlag},</if>
        <if test="operId != null">OPER_ID = #{operId},</if>
        OPER_TIME = CURRENT_TIMESTAMP
        WHERE TA_ID = #{taId}
    </update>

    <!--单表修改-->
    <update id="updateTaByMap" parameterType="java.util.HashMap">
        UPDATE ta_info
        SET
        <if test="shaTaId != null">SHA_TA_ID = #{shaTaId},</if>
        <if test="salt != null">SALT = #{salt},</if>
        <if test="appLicense != null">APP_LICENSE = #{appLicense},</if>
        <if test="taName != null">TA_NAME = #{taName},</if>
        <if test="spId != null">SP_ID = #{spId},</if>
        <if test="signReqId != null">SIGN_REQ_ID = #{signReqId},</if>
        <if test="sdId != null">SD_ID = #{sdId},</if>
        <if test="teeId != null">TEE_ID = #{teeId},</if>
        <if test="version != null">VERSION = #{version},</if>
        <if test="submitter != null">SUBMITTER = #{submitter},</if>
        <if test="description != null">DESCRIPTION = #{description},</if>
        <if test="deleteFlag != null">DELETE_FLAG = #{deleteFlag},</if>
        <if test="operId != null">OPER_ID = #{operId},</if>
        OPER_TIME = CURRENT_TIMESTAMP
        WHERE TA_ID = #{taId}
    </update>

    <!--批量逻辑删除-->
    <update id="deleteLogic" parameterType="java.util.HashMap">
        UPDATE ta_info
        SET
        <if test="deleteFlag != null">DELETE_FLAG = #{deleteFlag},</if>
        <if test="operId != null">OPER_ID = #{operId},</if>
        OPER_TIME = CURRENT_TIMESTAMP
        WHERE TA_ID IN
        <foreach collection="idList" item="itemId" index="index"
                 open="(" close=")" separator=",">
            #{itemId}
        </foreach>
    </update>

    <select id="selectTaInfo" parameterType="TaInfo" resultMap="ResultMap_TaInfo">
        SELECT <include refid="sql_select"/>
        FROM ta_info
        <where>
            TA_ID = #{taId}
            AND DELETE_FLAG = #{deleteFlag}
        </where>
    </select>

    <select id="selectTaInfoByMap" parameterType="java.util.HashMap" resultMap="ResultMap_TaInfo">
        SELECT <include refid="sql_select"/>
        FROM ta_info
        <where>
            <if test="taId != null">
                AND TA_ID = #{taId}
            </if>
            <if test="shaTaId != null">
                AND SHA_TA_ID = #{shaTaId}
            </if>
            <if test="taName != null">
                AND TA_NAME = #{taName}
            </if>
            <if test="spId != null">
                AND SP_ID = #{spId}
            </if>
            <if test="signReqId != null">
                AND SIGN_REQ_ID = #{signReqId}
            </if>
            <if test="deleteFlag != -1">
                AND DELETE_FLAG = #{deleteFlag}
            </if>
            <if test="operId != null">
                AND OPER_ID = #{operId}
            </if>
            <if test="startTime != null">
                AND CREATE_TIME &gt;= #{startTime}
            </if>
            <if test="endTime != null">
                AND CREATE_TIME &lt;= #{endTime}
            </if>
            <if test="start != null">
                limit #{start},#{limit}
            </if>
        </where>
    </select>
    <!--in use-->
    <select id="selectByMap" parameterType="java.util.HashMap" resultMap="ResultMap_TaInfoVO">
        select temp.*,tci.CAPABILITY_ID , tci.CAPABILITY_VALUE ,
        tci.DESCRIPTION DESCRIPTION_tci, tci.DELETE_FLAG DELETE_FLAG_tci, tci.CREATE_TIME CREATE_TIME_tci,
        tci.OPER_ID OPER_ID_tci, tci.OPER_TIME OPER_TIME_tci
        from (
            select <include refid="sql_select_TaInfoVO"/>

        from ta_info ta
        inner join sp_info sp on ta.SP_ID=sp.SP_ID
        inner join sd_info sd on ta.SD_ID=sd.SD_ID
        inner join sub_tee_info tee on ta.TEE_ID=tee.TEE_ID

        left join signature_req sr on sr.SIGN_REQ_ID = ta.SIGN_REQ_ID
        left join image_type it on sr.IMAGE_TYPE_ID = it.IMAGE_TYPE_ID
        left join file_info fi on sr.FILE_ID = fi.FILE_ID

            <where>
                <if test="taId != null">
                    AND ta.TA_ID = #{taId}
                </if>
                <if test="shaTaId != null">
                    AND ta.SHA_TA_ID = #{shaTaId}
                </if>
                <if test="taName != null">
                    AND ta.TA_NAME = #{taName}
                </if>
                <if test="submitter != null">
                    AND ta.submitter = #{submitter}
                </if>
                <if test="spId != null">
                    AND ta.SP_ID = #{spId}
                </if>
                <if test="signReqId != null">
                    AND ta.SIGN_REQ_ID = #{signReqId}
                </if>
                <if test="deleteFlag != null">
                    and ta.DELETE_FLAG = #{deleteFlag}
                    and sp.DELETE_FLAG = #{deleteFlag}
                    and sd.DELETE_FLAG = #{deleteFlag}
                    and tee.DELETE_FLAG = #{deleteFlag}
                </if>
                <if test="operId != null">
                    AND ta.OPER_ID = #{operId}
                </if>
                <if test="startTime != null">
                    AND ta.CREATE_TIME &gt;= #{startTime}
                </if>
                <if test="endTime != null">
                    AND ta.CREATE_TIME &lt;= #{endTime}
                </if>
                <if test="start != null">
                    order by ta.TA_ID desc
                    limit #{start},#{limit}
                </if>
            </where>
        ) temp
        LEFT JOIN ta_capability_r tcr
        on temp.TA_ID=tcr.TA_ID
        LEFT JOIN tee_capability_info tci
        on tci.capability_ID= tcr.capability_ID


    </select>

    <!--in use-->
    <select id="selectByMap3" parameterType="java.util.HashMap" resultMap="ResultMap_TaInfoVO">
        select temp.*,tci.CAPABILITY_ID , tci.CAPABILITY_VALUE ,
        tci.DESCRIPTION DESCRIPTION_tci, tci.DELETE_FLAG DELETE_FLAG_tci, tci.CREATE_TIME CREATE_TIME_tci,
        tci.OPER_ID OPER_ID_tci, tci.OPER_TIME OPER_TIME_tci
        from (
            select <include refid="sql_select_TaInfoVO"/>
            from ta_info ta,sp_info sp,sd_info sd,sub_tee_info tee
            <where>
                ta.SP_ID=sp.SP_ID
                and ta.SD_ID=sd.SD_ID
                and ta.TEE_ID=tee.TEE_ID
                <if test="taId != null">
                    AND ta.TA_ID = #{taId}
                </if>
                <if test="shaTaId != null">
                    AND ta.SHA_TA_ID = #{shaTaId}
                </if>
                <if test="taName != null">
                    AND ta.TA_NAME = #{taName}
                </if>
                <if test="submitter != null">
                    AND ta.submitter = #{submitter}
                </if>
                <if test="spId != null">
                    AND ta.SP_ID = #{spId}
                </if>
                <if test="signReqId != null">
                    AND ta.SIGN_REQ_ID = #{signReqId}
                </if>
                <if test="deleteFlag != null">
                    and ta.DELETE_FLAG = #{deleteFlag}
                    and sp.DELETE_FLAG = #{deleteFlag}
                    and sd.DELETE_FLAG = #{deleteFlag}
                    and tee.DELETE_FLAG = #{deleteFlag}
                </if>
                <if test="operId != null">
                    AND ta.OPER_ID = #{operId}
                </if>
                <if test="startTime != null">
                    AND ta.CREATE_TIME &gt;= #{startTime}
                </if>
                <if test="endTime != null">
                    AND ta.CREATE_TIME &lt;= #{endTime}
                </if>
                <if test="start != null">
                    limit #{start},#{limit}
                </if>
            </where>

        ) temp
        LEFT JOIN ta_capability_r tcr
        on temp.TA_ID=tcr.TA_ID
        LEFT JOIN tee_capability_info tci
        on tci.capability_ID= tcr.capability_ID


    </select>

    <!--not in use-->
    <select id="selectCountByMap" parameterType="java.util.HashMap" resultType="integer">
        select count(ta.TA_ID)
        from ta_info ta,sp_info sp,sd_info sd,sub_tee_info tee
        <where>
            ta.SP_ID=sp.SP_ID
            and ta.SD_ID=sd.SD_ID
            and ta.TEE_ID=tee.TEE_ID
            <if test="taId != null">
                AND ta.TA_ID = #{taId}
            </if>
            <if test="shaTaId != null">
                AND ta.SHA_TA_ID = #{shaTaId}
            </if>
            <if test="taName != null">
                AND ta.TA_NAME = #{taName}
            </if>
            <if test="spId != null">
                AND ta.SP_ID = #{spId}
            </if>
            <if test="signReqId != null">
                AND ta.SIGN_REQ_ID = #{signReqId}
            </if>
            <if test="deleteFlag != null">
                and ta.DELETE_FLAG = #{deleteFlag}
                and sp.DELETE_FLAG = #{deleteFlag}
                and sd.DELETE_FLAG = #{deleteFlag}
                and tee.DELETE_FLAG = #{deleteFlag}
            </if>
            <if test="operId != null">
                AND ta.OPER_ID = #{operId}
            </if>
            <if test="startTime != null">
                AND ta.CREATE_TIME &gt;= #{startTime}
            </if>
            <if test="endTime != null">
                AND ta.CREATE_TIME &lt;= #{endTime}
            </if>
        </where>
    </select>



</mapper>