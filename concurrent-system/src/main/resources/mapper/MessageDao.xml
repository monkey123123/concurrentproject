<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org/DTD Mapper 3.0" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="me.monkey.dao.IMessageDao">

    <!--add by Allen -->
    <resultMap id="ResultMap_MESSAGE" type="com.beanpodtech.pkms.common.model.Message" >
        <id column="MESSAGE_ID" property="messageId" jdbcType="INTEGER" />
        <id column="SHOW_TYPE" property="showType" jdbcType="INTEGER" />
        <result column="PUSH_TYPE" property="pushType" jdbcType="INTEGER" />
        <result column="CONTENT" property="content" jdbcType="VARCHAR" />
        <result column="NEED_ACK" property="needAck" jdbcType="INTEGER" />
        <result column="EXPIRE_TIME" property="expireTime" jdbcType="TIMESTAMP" />
        <result column="CREATE_TIME" property="createTime" jdbcType="TIMESTAMP" />
        <result column="OPER_ID" property="operId" jdbcType="VARCHAR" />
        <result column="OPER_TIME" property="operTime" jdbcType="TIMESTAMP" />
    </resultMap>

    <!-- message 操作 -->
    <insert id="insertMessage" parameterType="Message" useGeneratedKeys="true" keyProperty="messageId">
        INSERT INTO mp_message(SHOW_TYPE,PUSH_TYPE,CONTENT,NEED_ACK,EXPIRE_TIME,CREATE_TIME,OPER_ID,OPER_TIME)
        VALUES (#{showType},#{pushType},#{content},#{needAck},#{expireTime},#{createTime},#{operId},CURRENT_TIMESTAMP )
    </insert>

    <update id="updateMessage" parameterType="Message">
        UPDATE mp_message
        SET
            <if test="showType != null">SHOW_TYPE = #{showType},</if>
            OPER_ID = #{operId},
            OPER_TIME = CURRENT_TIMESTAMP
        WHERE MESSAGE_ID = #{messageId}
    </update>

    <select id="selectMessageTemp" parameterType="java.util.HashMap" resultMap="ResultMap_MESSAGE">
        SELECT MESSAGE_ID,SHOW_TYPE,PUSH_TYPE,CONTENT,NEED_ACK,CREATE_TIME,OPER_ID,OPER_TIME
        FROM mp_message
        <where>
            <if test="messageId != -1">
                AND MESSAGE_ID = #{messageId}
            </if>
            <if test="showType != null">
                AND SHOW_TYPE = #{showType}
            </if>
            <if test="pushType != null">
                AND PUSH_TYPE = #{pushType}
            </if>
            <if test="content != null">
                AND CONTENT &gt;= #{content}
            </if>
            <if test="needAck != -1">
                AND NEED_ACK = #{needAck}
            </if>
            <if test="createTime != null">
                AND CREATE_TIME &lt;= #{createTime}
            </if>
            <if test="operId != null">
                AND OPER_TIME &lt;= #{operId}
            </if>
        </where>
    </select>



    <select id="selectMessage" parameterType="java.util.HashMap" resultMap="ResultMap_MESSAGE">
        SELECT m.MESSAGE_ID,SHOW_TYPE,PUSH_TYPE,CONTENT,NEED_ACK,m.EXPIRE_TIME,m.CREATE_TIME,m.OPER_ID,m.OPER_TIME
        FROM mp_message m, mp_phone_message pm
        <where>
              m.MESSAGE_ID=pm.MESSAGE_ID
            <if test="needAck != null">
                AND m.NEED_ACK = #{needAck}
            </if>
            <if test="expireTime != null">
                AND m.EXPIRE_TIME > #{expireTime}
            </if>
            <if test="status != null">
                AND pm.STATUS = #{status}
            </if>
            <if test="phoneId != null">
                AND pm.PHONE_ID = #{phoneId}
            </if>

        </where>
    </select>

</mapper>